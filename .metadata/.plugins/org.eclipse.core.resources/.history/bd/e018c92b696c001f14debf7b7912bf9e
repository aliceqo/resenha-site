document.addEventListener('DOMContentLoaded', () => {
    const form1 = document.getElementById('form-edit-resenha');
    const form2 = document.getElementById('resenha_frase');
    const botEditarResenha = document.getElementById('bot-editar-resenha');
    const botExcluirResenha = document.getElementById('bot-excluir-resenha');

    // Função para buscar dados do servidor
    function fetchData() {
        fetch('/back-end/excluirEditar?id=123') // Substitua com o ID correto
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao buscar dados');
                }
                return response.json();
            })
            .then(data => {
                // Preenchendo os campos do formulário com os dados recebidos
                document.getElementById('resenhaId').value = data.resenhaId || '';
                document.getElementById('titulo').value = data.titulo || '';
                document.getElementById('idade_leitura').value = data.idade_leitura || '';
                document.getElementById('livro').value = data.livro || '';
                document.getElementById('autor').value = data.autor || '';
                document.getElementById('tradutor').value = data.tradutor || '';
                document.getElementById('generos').value = data.generos || '';
                document.getElementById('idioma').value = data.idioma || '';
                document.getElementById('editora').value = data.editora || '';
                document.getElementById('numero_paginas').value = data.numero_paginas || '';
                document.getElementById('frase_destaque').value = data.frase_destaque || '';
                document.getElementById('resenha').value = data.conteudo_resenha || '';
                
                // Preencher a imagem se houver
                const imagemCapa = document.getElementById('imagem_capa');
                if (data.urlFoto) {
                    imagemCapa.src = data.urlFoto;
                }
            })
            .catch(error => {
                console.error('Erro ao buscar dados da resenha:', error);
            });
    }

    fetchData(); // Buscar dados quando o documento estiver pronto

    // Enviar dados do formulário 1 e 2
    function submitForm(form, url) {
        const formData = new FormData(form);

        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao enviar dados');
            }
            return response.text();
        })
        .then(message => {
            console.log(message);
            window.location.href = 'editarResenha.jsp';
        })
        .catch(error => {
            console.error(error);
            window.location.href = 'erro.html';
        });
    }

    form1.addEventListener('submit', (e) => {
        e.preventDefault();
        submitForm(form1, '/back-end/excluirEditar');
    });

    form2.addEventListener('submit', (e) => {
        e.preventDefault();
        submitForm(form2, '/back-end/excluirEditar');
    });

    // Enviar dados para editar uma resenha
    botEditarResenha.addEventListener('click', () => {
        const formData = new FormData();

        formData.append('id', document.getElementById('resenhaId').value);
        formData.append('titulo', document.getElementById('titulo').value);
        formData.append('idade_leitura', document.getElementById('idade_leitura').value);
        formData.append('livro', document.getElementById('livro').value);
        formData.append('autor', document.getElementById('autor').value);
        formData.append('tradutor', document.getElementById('tradutor').value);
        formData.append('generos', document.getElementById('generos').value);
        formData.append('idioma', document.getElementById('idioma').value);
        formData.append('editora', document.getElementById('editora').value);

        const numeroPaginas = document.getElementById('numero_paginas').value;
        const numeroPaginasNumber = parseInt(numeroPaginas, 10);
        formData.append('numero_paginas', isNaN(numeroPaginasNumber) ? 0 : numeroPaginasNumber);

        formData.append('frase_destaque', document.getElementById('frase_destaque').value);
        formData.append('conteudo_resenha', document.getElementById('resenha').value);

        const urlFotoInput = document.getElementById('url_foto');
        if (urlFotoInput && urlFotoInput.files.length > 0) {
            formData.append('url_foto', urlFotoInput.files[0]);
        }

        fetch('/back-end/excluirEditar', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(data => {
            console.log('Resenha atualizada com sucesso:', data);
            alert('Resenha atualizada com sucesso!');
        })
        .catch(error => {
            console.error('Erro ao atualizar a resenha:', error);
            alert('Erro ao atualizar a resenha.');
        });
    });

    // Excluir uma resenha
    botExcluirResenha.addEventListener('click', () => {
        const id = document.getElementById('resenhaId').value;

        fetch(`/back-end/excluirEditar?id=${id}`, {
            method: 'DELETE'
        })
        .then(response => response.text())
        .then(data => {
            console.log('Resenha excluída com sucesso:', data);
            alert('Resenha excluída com sucesso!');
        })
        .catch(error => {
            console.error('Erro ao excluir a resenha:', error);
            alert('Erro ao excluir a resenha.');
        });
    });
});